{% extends 'base.html' %}
{% load password_tags %}

{% block title %}Пароли - makrei.ru{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Пароли</h1>
    {% if entries %}
    <a href="{% url 'passwords:create' %}" class="btn btn-primary">Добавить пароль</a>
    <a href="{% url 'passwords:change_master_password' %}" class="btn btn-secondary">Изменить мастер-пароль</a>
    <form method="post" action="{% url 'passwords:clear_session' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary">Забыть мастер-пароль</button>
    </form>
    {% endif %}
</div>

{% if not has_passwords %}
<div class="password-form-container">
    <form method="post" class="master-password-form">
        {% csrf_token %}
        <h2>Установите мастер-пароль</h2>
        <p class="help-text">Для начала работы необходимо придумать мастер-пароль. Он будет использоваться для шифрования всех ваших паролей.</p>
        
        <div class="form-group">
            {{ setup_form.master_password.label_tag }}
            {{ setup_form.master_password }}
            {% if setup_form.master_password.errors %}
            <div class="error-message">{{ setup_form.master_password.errors }}</div>
            {% endif %}
            {% if setup_form.master_password.help_text %}
            <small class="form-text">{{ setup_form.master_password.help_text }}</small>
            {% endif %}
        </div>
        
        <div class="form-group">
            {{ setup_form.master_password_confirm.label_tag }}
            {{ setup_form.master_password_confirm }}
            {% if setup_form.master_password_confirm.errors %}
            <div class="error-message">{{ setup_form.master_password_confirm.errors }}</div>
            {% endif %}
            {% if setup_form.master_password_confirm.help_text %}
            <small class="form-text">{{ setup_form.master_password_confirm.help_text }}</small>
            {% endif %}
        </div>
        
        {% if setup_form.non_field_errors %}
        <div class="error-message">
            {{ setup_form.non_field_errors }}
        </div>
        {% endif %}
        
        <button type="submit" class="btn btn-primary">Установить мастер-пароль</button>
    </form>
</div>
{% elif not entries %}
<div class="password-form-container">
    <form method="post" class="master-password-form">
        {% csrf_token %}
        <h2>Введите мастер-пароль</h2>
        <p class="help-text">Для просмотра паролей необходимо ввести контрольную фразу-ключ.</p>
        
        <div class="form-group">
            {{ form.master_password.label_tag }}
            {{ form.master_password }}
            {% if form.master_password.errors %}
            <div class="error-message">{{ form.master_password.errors }}</div>
            {% endif %}
            {% if form.master_password.help_text %}
            <small class="form-text">{{ form.master_password.help_text }}</small>
            {% endif %}
        </div>
        
        <button type="submit" class="btn btn-primary">Расшифровать пароли</button>
    </form>
</div>
{% else %}
<div class="passwords-table-container">
    <table class="passwords-table">
        <thead>
            <tr>
                <th>Сервис</th>
                <th>Логин</th>
                <th>Email</th>
                <th>Пароль</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr>
                <td><strong>{{ entry.service }}</strong></td>
                <td>{{ entry.login }}</td>
                <td>{{ entry.email|default:"—" }}</td>
                <td>
                    {% if entry.id in decrypted_passwords %}
                    <code class="password-display" data-password="{{ decrypted_passwords|get_item:entry.id }}">
                        <span class="password-hidden">••••••••</span>
                        <span class="password-visible" style="display: none;">{{ decrypted_passwords|get_item:entry.id }}</span>
                    </code>
                    <button type="button" class="btn-toggle-password" onclick="togglePassword(this)">
                        Показать
                    </button>
                    {% else %}
                    <span class="error">Ошибка расшифровки</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'passwords:update' entry.pk %}" class="btn btn-sm">Редактировать</a>
                    <form method="post" action="{% url 'passwords:delete' entry.pk %}" style="display: inline;" onsubmit="return confirm('Вы уверены, что хотите удалить этот пароль?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="empty-state">Пароли не найдены. <a href="{% url 'passwords:create' %}">Добавьте первый пароль</a>.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
function togglePassword(button) {
    const row = button.closest('td');
    const passwordDisplay = row.querySelector('.password-display');
    const hidden = passwordDisplay.querySelector('.password-hidden');
    const visible = passwordDisplay.querySelector('.password-visible');
    
    if (hidden.style.display === 'none') {
        hidden.style.display = 'inline';
        visible.style.display = 'none';
        button.textContent = 'Показать';
    } else {
        hidden.style.display = 'none';
        visible.style.display = 'inline';
        button.textContent = 'Скрыть';
    }
}
</script>
{% endblock %}

